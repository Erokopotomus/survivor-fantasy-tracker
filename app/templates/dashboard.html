{% extends "base.html" %}
{% block title %}Dashboard - Survivor Fantasy{% endblock %}
{% block content %}
<div id="page-content">
    <div id="season-status-bar" class="hidden" style="display:none;align-items:center;gap:1rem;padding:0.75rem 1rem;margin-bottom:1rem;border-radius:6px;border:1px solid var(--border-color,#444);background:var(--card-bg,#1a1a1a);">
        <div style="flex:1;">
            <span class="text-muted" style="font-size:0.85rem;">Season Status:</span>
            <strong id="status-label" style="margin-left:0.4rem;text-transform:uppercase;letter-spacing:0.05em;"></strong>
        </div>
        <div id="status-actions"></div>
    </div>
    <div class="flex-between mb-2">
        <h1>Leaderboard</h1>
        <div id="season-info" class="text-muted" style="font-family:'Almendra',serif;font-style:italic;"></div>
    </div>
    <div id="leaderboard-loading" class="loading"><span class="spinner"></span> Loading...</div>
    <div id="leaderboard-content" class="hidden"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const auth = requireAuth();
    if (!auth) return;

    try {
        await populateSeasonSelector();
        const seasonId = await getCurrentSeasonId();
        if (!seasonId) {
            document.getElementById('leaderboard-loading').innerHTML = '<p class="text-muted">No seasons found.</p>';
            return;
        }

        const seasons = await getSeasons();
        const season = seasons.find(s => s.id === seasonId);
        document.getElementById('season-info').textContent = season ? season.name : '';

        if (auth.is_commissioner && season) {
            renderStatusBar(season, seasonId);
        }

        const lb = await apiGet(`/api/seasons/${seasonId}/leaderboard`);
        const container = document.getElementById('leaderboard-content');

        if (lb.entries.length === 0) {
            container.innerHTML = '<p class="text-muted">No scores yet. Draft some castaways and start scoring episodes!</p>';
        } else {
            // Condensed leaderboard table
            let html = '<div class="card">';
            html += '<table><thead><tr><th>Rank</th><th>Player</th><th>Prediction Bonus</th><th>Total</th></tr></thead><tbody>';
            for (const entry of lb.entries) {
                const pc = getPlayerColor(entry.player_name);
                html += `<tr>
                    <td style="color:${pc.accent};font-weight:700;font-family:'Cinzel',serif;">#${entry.rank}</td>
                    <td><strong style="color:${pc.accent}">${entry.player_name}</strong>${entry.is_commissioner ? ' <span class="badge badge-commissioner">Commish</span>' : ''}</td>
                    <td>${formatScore(entry.prediction_bonus)}</td>
                    <td><span class="score" style="color:${pc.accent}">${entry.grand_total.toFixed(2)}</span></td>
                </tr>`;
            }
            html += '</tbody></table></div>';

            // Roster cards
            html += '<h2 class="mt-2 mb-1">Rosters</h2>';
            html += '<div class="roster-cards">';
            for (const entry of lb.entries) {
                const pc = getPlayerColor(entry.player_name);
                html += `<div class="roster-card" data-player="${entry.player_name}">`;
                html += `<div class="roster-card-header">`;
                html += `<span class="player-name">${entry.player_name}${entry.is_commissioner ? ' <span class="badge badge-commissioner">Commish</span>' : ''}</span>`;
                html += `<span class="player-total">${entry.grand_total.toFixed(2)}</span>`;
                html += `</div>`;

                for (const c of entry.roster_breakdown) {
                    const isEliminated = c.status && c.status !== 'active';
                    html += `<a href="/castaway/${c.castaway_id}" class="roster-castaway${isEliminated ? ' eliminated' : ''}">`;
                    html += renderPhoto(c.photo_url, c.castaway_name, 40);
                    html += `<div class="castaway-info">`;
                    html += `<div class="name">${c.castaway_name}</div>`;
                    html += `<div class="pickup-type">${c.pickup_type}${isEliminated ? ' &middot; voted out' : ''}</div>`;
                    html += `</div>`;
                    html += `<div class="castaway-score" style="color:${pc.accent}">${c.total_score.toFixed(2)}</div>`;
                    html += `</a>`;
                }

                if (entry.prediction_bonus > 0) {
                    html += `<div style="text-align:right;padding-top:0.5rem;font-size:0.8rem;color:var(--mud);font-family:'Source Sans Pro',sans-serif;">Prediction bonus: +${entry.prediction_bonus.toFixed(2)}</div>`;
                }
                html += `</div>`;
            }
            html += '</div>';

            container.innerHTML = html;
        }

        document.getElementById('leaderboard-loading').classList.add('hidden');
        container.classList.remove('hidden');
    } catch (err) {
        document.getElementById('leaderboard-loading').innerHTML = `<p class="alert alert-error">${err.message}</p>`;
    }
});

const STATUS_FLOW = {
    setup:    { next: 'drafting',  label: 'Start Draft',      color: '#D4930D' },
    drafting: { next: 'active',    label: 'Start Season',     color: '#10B981' },
    active:   { next: 'complete',  label: 'Complete Season',  color: '#3B82F6' },
    complete: { next: 'active',    label: 'Reopen Season',    color: '#F97316' },
};

const STATUS_COLORS = {
    setup: '#999', drafting: '#D4930D', active: '#10B981', complete: '#3B82F6',
};

function renderStatusBar(season, seasonId) {
    const bar = document.getElementById('season-status-bar');
    const label = document.getElementById('status-label');
    const actions = document.getElementById('status-actions');
    const status = season.status;

    label.textContent = status;
    label.style.color = STATUS_COLORS[status] || '#ccc';

    const flow = STATUS_FLOW[status];
    if (flow) {
        actions.innerHTML = `<button class="btn btn-sm" style="border-color:${flow.color};color:${flow.color};" onclick="transitionSeason(${seasonId}, '${flow.next}')">${flow.label} &rarr;</button>`;
    } else {
        actions.innerHTML = '';
    }

    bar.classList.remove('hidden');
    bar.style.display = 'flex';
}

async function transitionSeason(seasonId, newStatus) {
    const flow = Object.values(STATUS_FLOW).find(f => f.next === newStatus);
    const label = flow ? flow.label : `Change to ${newStatus}`;
    if (!confirm(`${label}? This will change the season status to "${newStatus}".`)) return;

    try {
        await apiPatch(`/api/seasons/${seasonId}/status`, { status: newStatus });
        location.reload();
    } catch (err) {
        alert('Failed: ' + err.message);
    }
}
</script>
{% endblock %}
