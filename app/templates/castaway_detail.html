{% extends "base.html" %}
{% block title %}Castaway Detail - Survivor Fantasy{% endblock %}
{% block content %}
<div id="page-content">
    <div id="detail-loading" class="loading"><span class="spinner"></span> Loading...</div>
    <div id="detail-content" class="hidden"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    if (!requireAuth()) return;

    const castawayId = {{ castaway_id }};
    const seasonId = await getCurrentSeasonId();
    if (!seasonId) return;

    try {
        const detail = await apiGet(`/api/seasons/${seasonId}/castaways/${castawayId}/detail`);
        const container = document.getElementById('detail-content');
        const tribeColor = getTribeColor(detail.starting_tribe);

        let html = `<div class="detail-photo-wrapper">`;
        if (detail.photo_url) {
            html += `<img src="${detail.photo_url}" alt="${detail.name}" style="width:100px;height:100px;border-color:${tribeColor};">`;
        } else {
            html += `<div class="photo-initials" style="width:100px;height:100px;font-size:38px;border-color:${tribeColor};">${getInitials(detail.name)}</div>`;
        }
        html += `<div>
                <h1 style="font-size:1.6rem;">${detail.name}</h1>
                <p style="font-family:'Almendra',serif;font-style:italic;color:var(--mud);">${detail.occupation || ''} ${detail.age ? '&middot; Age ' + detail.age : ''}</p>
                <p style="margin-top:0.25rem;">
                    <span style="color:${tribeColor};font-family:'Cinzel',serif;font-weight:700;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.1em;">${detail.starting_tribe || ''}</span>
                    ${detail.current_tribe && detail.current_tribe !== detail.starting_tribe ? ' &rarr; <span style="color:' + getTribeColor(detail.current_tribe) + ';font-family:Cinzel,serif;font-weight:700;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.1em;">' + detail.current_tribe + '</span>' : ''}
                    &nbsp; ${statusBadge(detail.status)}
                    <span class="score" style="font-size:1.3rem;margin-left:0.5rem;color:var(--torch-yellow);">${detail.total_score.toFixed(2)} pts</span>
                </p>
            </div>
        </div>`;

        if (detail.drafted_by.length > 0) {
            const draftedNames = detail.drafted_by.map(name => {
                const pc = getPlayerColor(name);
                return '<strong style="color:' + pc.accent + '">' + name + '</strong>';
            }).join(', ');
            html += `<p style="color:var(--mud);margin-bottom:1rem;">Drafted by: ${draftedNames}</p>`;
        }

        if (detail.episode_scores.length > 0) {
            html += '<div class="card"><div class="card-header">Episode Breakdown</div>';
            html += '<table><thead><tr><th>Episode</th><th>Title</th><th>Score</th><th>Events</th></tr></thead><tbody>';
            for (const ep of detail.episode_scores) {
                const events = Object.entries(ep.event_data || {})
                    .filter(([k, v]) => v > 0)
                    .map(([k, v]) => `${k.replace(/_/g, ' ')}: ${v}`)
                    .join(', ');
                html += `<tr>
                    <td style="font-family:'Cinzel',serif;font-size:0.8rem;">Ep ${ep.episode_number}</td>
                    <td style="font-family:'Almendra',serif;">${ep.episode_title || '-'}</td>
                    <td>${formatScore(ep.calculated_score)}</td>
                    <td class="text-muted" style="font-size:0.78rem">${events || '-'}</td>
                </tr>`;
            }
            html += '</tbody></table></div>';
        } else {
            html += '<p class="text-muted" style="font-family:\'Almendra\',serif;font-style:italic;">No episode scores yet.</p>';
        }

        container.innerHTML = html;
        document.getElementById('detail-loading').classList.add('hidden');
        container.classList.remove('hidden');
    } catch (err) {
        document.getElementById('detail-loading').innerHTML = `<p class="alert alert-error">${err.message}</p>`;
    }
});
</script>
{% endblock %}
