{% extends "base.html" %}
{% block title %}Score Episode - Survivor Fantasy{% endblock %}
{% block content %}
<div id="page-content">
    <div class="flex-between mb-2">
        <h1>Score Episode</h1>
    </div>
    <div id="scoring-alert"></div>

    <div class="episode-selector">
        <label style="margin:0;margin-right:0.5rem;">Episode:</label>
        <select id="episode-select"><option value="">Loading...</option></select>
        <button class="btn btn-outline" onclick="loadTemplate()">Load Template</button>
        <button class="btn btn-green" onclick="createNewEpisode()">+ New Episode</button>
    </div>

    <div id="new-episode-form" class="card hidden">
        <h3 class="card-header">Create New Episode</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
            <div class="form-group">
                <label>Episode Number</label>
                <input type="number" id="new-ep-number" min="1">
            </div>
            <div class="form-group">
                <label>Options</label>
                <div style="display:flex;gap:1rem;padding-top:0.25rem">
                    <label style="display:flex;align-items:center;gap:0.25rem;font-size:0.8rem">
                        <input type="checkbox" id="new-ep-merge" style="width:auto"> Merge
                    </label>
                    <label style="display:flex;align-items:center;gap:0.25rem;font-size:0.8rem">
                        <input type="checkbox" id="new-ep-finale" style="width:auto"> Finale
                    </label>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>Episode Recap (optional — improves AI accuracy)</label>
            <textarea id="new-ep-recap" rows="4" placeholder="Paste an episode recap or key moments for better AI scoring..." style="width:100%;resize:vertical;"></textarea>
        </div>
        <div class="form-group">
            <label>Confessional Counts Screenshot (optional)</label>
            <div style="display:flex;align-items:center;gap:0.75rem;">
                <button type="button" class="btn btn-outline" onclick="document.getElementById('new-ep-confessional-file').click()" style="padding:0.5rem 1rem;border-color:#d4930d;color:#d4930d;">
                    &#128247; Attach Screenshot
                </button>
                <input type="file" id="new-ep-confessional-file" accept="image/jpeg,image/png,image/webp" style="display:none" onchange="previewConfessionalAttachment(this)">
                <span id="confessional-attachment-name" style="font-size:0.8rem;color:var(--text-muted);"></span>
                <button type="button" id="confessional-attachment-clear" class="hidden" onclick="clearConfessionalAttachment()" style="background:none;border:none;color:#e74c3c;cursor:pointer;font-size:0.8rem;">&#x2715; Remove</button>
            </div>
            <div id="confessional-attachment-preview" class="hidden" style="margin-top:0.5rem;">
                <img id="confessional-preview-img" style="max-height:80px;border-radius:4px;border:1px solid var(--border-color);">
            </div>
        </div>
        <div style="display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap;">
            <button class="btn" onclick="aiCreateEpisode()" id="ai-create-btn" style="flex:2;padding:0.75rem;font-size:1rem;background:linear-gradient(135deg,#7c3aed,#6d28d9);border:none;">
                <span style="margin-right:0.5rem;">&#9733;</span> Create &amp; Score with AI
            </button>
            <button class="btn btn-outline" onclick="submitNewEpisode()" style="flex:1;padding:0.75rem;">Create Only (Manual)</button>
            <span id="ai-create-loading" class="hidden"><span class="spinner"></span> Creating &amp; scoring...</span>
        </div>
    </div>

    <div id="scoring-loading" class="loading hidden"><span class="spinner"></span> Loading template...</div>
    <div id="scoring-grid-container" class="hidden"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSeasonId = null;
let currentTemplate = null;

document.addEventListener('DOMContentLoaded', async () => {
    const auth = requireAuth();
    if (!auth || !auth.is_commissioner) {
        document.getElementById('page-content').innerHTML = '<p class="alert alert-error">Commissioner access required.</p>';
        return;
    }

    currentSeasonId = await getCurrentSeasonId();
    if (!currentSeasonId) return;

    await loadEpisodes();
});

async function loadEpisodes() {
    const eps = await apiGet(`/api/seasons/${currentSeasonId}/episodes`);
    const sel = document.getElementById('episode-select');
    sel.innerHTML = '<option value="">Select episode...</option>';
    for (const ep of eps) {
        const scored = ep.is_scored ? ' [SCORED]' : '';
        sel.innerHTML += `<option value="${ep.id}">Ep ${ep.episode_number}: ${ep.title || 'Untitled'}${scored}</option>`;
    }
}

function createNewEpisode() {
    document.getElementById('new-episode-form').classList.toggle('hidden');
}

async function submitNewEpisode() {
    const alertBox = document.getElementById('scoring-alert');
    try {
        const ep = await apiPost(`/api/seasons/${currentSeasonId}/episodes`, {
            episode_number: parseInt(document.getElementById('new-ep-number').value),
            is_merge: document.getElementById('new-ep-merge').checked,
            is_finale: document.getElementById('new-ep-finale').checked,
        });
        showAlert(alertBox, `Episode ${ep.episode_number} created!`, 'success');
        document.getElementById('new-episode-form').classList.add('hidden');
        await loadEpisodes();
        document.getElementById('episode-select').value = ep.id;
        loadTemplate();
    } catch (err) {
        showAlert(alertBox, err.message);
    }
}

function previewConfessionalAttachment(fileInput) {
    const nameSpan = document.getElementById('confessional-attachment-name');
    const clearBtn = document.getElementById('confessional-attachment-clear');
    const previewDiv = document.getElementById('confessional-attachment-preview');
    const previewImg = document.getElementById('confessional-preview-img');

    if (fileInput.files.length) {
        const file = fileInput.files[0];
        nameSpan.textContent = file.name;
        clearBtn.classList.remove('hidden');
        previewImg.src = URL.createObjectURL(file);
        previewDiv.classList.remove('hidden');
    }
}

function clearConfessionalAttachment() {
    document.getElementById('new-ep-confessional-file').value = '';
    document.getElementById('confessional-attachment-name').textContent = '';
    document.getElementById('confessional-attachment-clear').classList.add('hidden');
    document.getElementById('confessional-attachment-preview').classList.add('hidden');
}

async function aiCreateEpisode() {
    const alertBox = document.getElementById('scoring-alert');
    const epNum = document.getElementById('new-ep-number').value;
    if (!epNum) {
        showAlert(alertBox, 'Enter an episode number.');
        return;
    }

    const createBtn = document.getElementById('ai-create-btn');
    const loadingSpan = document.getElementById('ai-create-loading');
    createBtn.disabled = true;
    loadingSpan.classList.remove('hidden');

    try {
        const result = await apiPost(`/api/seasons/${currentSeasonId}/episodes/ai-create`, {
            episode_number: parseInt(epNum),
            is_merge: document.getElementById('new-ep-merge').checked,
            is_finale: document.getElementById('new-ep-finale').checked,
            recap_text: document.getElementById('new-ep-recap').value || null,
        });

        // Episode created — hide form, refresh dropdown
        document.getElementById('new-episode-form').classList.add('hidden');
        await loadEpisodes();

        // Select the new episode and load its template
        document.getElementById('episode-select').value = result.episode_id;
        await loadTemplate();

        // Pre-fill the grid with AI suggestions
        populateGridFromAi(result.suggestions);
        showAiNotes(result);

        const title = result.episode_title ? ` — "${result.episode_title}"` : '';
        let msg = `Episode ${result.episode_number} created${title}. AI filled ${result.suggestions.length} castaways.`;

        // If confessional screenshot was attached, parse it now
        const confFile = document.getElementById('new-ep-confessional-file');
        if (confFile.files.length) {
            loadingSpan.innerHTML = '<span class="spinner"></span> Parsing confessionals...';
            try {
                const formData = new FormData();
                formData.append('file', confFile.files[0]);
                const auth = getAuth();
                const resp = await fetch(`/api/seasons/${currentSeasonId}/episodes/${result.episode_id}/parse-confessionals`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${auth.access_token}` },
                    body: formData,
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || 'Parse failed');
                }
                const confResult = await resp.json();
                let matched = 0;
                for (const entry of confResult.confessionals) {
                    const row = document.querySelector(`tr[data-castaway-id="${entry.castaway_id}"]`);
                    if (!row) continue;
                    const input = row.querySelector('[data-rule="confessional_count"]');
                    if (!input) continue;
                    input.value = entry.count;
                    const cell = input.closest('td');
                    cell.classList.remove('ai-highlight');
                    cell.removeAttribute('title');
                    matched++;
                }
                msg += ` Confessionals filled for ${matched} castaways.`;
            } catch (confErr) {
                msg += ` Confessional parse failed: ${confErr.message}`;
            }
            clearConfessionalAttachment();
        }

        msg += ' Review and submit.';
        showAlert(alertBox, msg, 'success');
    } catch (err) {
        showAlert(alertBox, `AI Create error: ${err.message}`);
    } finally {
        createBtn.disabled = false;
        loadingSpan.classList.add('hidden');
        loadingSpan.innerHTML = '<span class="spinner"></span> Creating &amp; scoring...';
    }
}

async function loadTemplate() {
    const epId = document.getElementById('episode-select').value;
    if (!epId) return;

    const loading = document.getElementById('scoring-loading');
    const container = document.getElementById('scoring-grid-container');
    loading.classList.remove('hidden');
    container.classList.add('hidden');

    try {
        currentTemplate = await apiGet(`/api/seasons/${currentSeasonId}/episodes/${epId}/template`);
        renderGrid(currentTemplate);

        // If episode already has scores, load them into the grid
        try {
            const existing = await apiGet(`/api/seasons/${currentSeasonId}/episodes/${epId}/scores`);
            if (existing.events && existing.events.length > 0) {
                for (const ev of existing.events) {
                    const row = document.querySelector(`tr[data-castaway-id="${ev.castaway_id}"]`);
                    if (!row) continue;
                    for (const [ruleKey, value] of Object.entries(ev.event_data)) {
                        const input = row.querySelector(`[data-rule="${ruleKey}"]`);
                        if (!input) continue;
                        if (input.tagName === 'SELECT') {
                            input.value = value ? '1' : '0';
                        } else {
                            input.value = value;
                        }
                    }
                }
                showAlert(document.getElementById('scoring-alert'), `Loaded existing scores for ${existing.events.length} castaways. Edit and re-submit as needed.`, 'success');
            }
        } catch (e) {
            // No existing scores — that's fine, blank grid
        }

        loading.classList.add('hidden');
        container.classList.remove('hidden');
    } catch (err) {
        loading.innerHTML = `<p class="alert alert-error">${err.message}</p>`;
    }
}

function renderGrid(template) {
    const container = document.getElementById('scoring-grid-container');
    const rules = template.rules;
    const castaways = template.castaways;

    let html = '<div class="scoring-grid"><table>';

    // Header row
    html += '<thead><tr><th style="position:sticky;left:0;background:var(--bg-input);z-index:25;vertical-align:bottom;padding-bottom:0.5rem;">Castaway</th>';
    for (const rule of rules) {
        const tooltip = `${rule.rule_name} (${rule.points > 0 ? '+' : ''}${rule.points} pts, ${rule.multiplier})`;
        html += `<th class="rule-header" title="${tooltip}">${rule.rule_name}</th>`;
    }
    html += '</tr></thead><tbody>';

    // Castaway rows
    for (const c of castaways) {
        html += `<tr data-castaway-id="${c.castaway_id}">`;
        html += `<td class="castaway-name">${c.castaway_name}</td>`;
        for (const rule of rules) {
            const isBinary = rule.multiplier === 'binary';
            const defaultVal = 0;
            if (isBinary) {
                html += `<td><select data-rule="${rule.rule_key}" style="width:60px;padding:0.3rem;text-align:center">
                    <option value="0">-</option><option value="1">Yes</option>
                </select></td>`;
            } else {
                html += `<td><input type="number" data-rule="${rule.rule_key}" value="${defaultVal}" min="0" step="1"></td>`;
            }
        }
        html += '</tr>';
    }

    html += '</tbody></table></div>';

    // AI Assist + Confessional Upload + Submit buttons
    html += `<div style="display:flex;gap:1rem;margin-top:1rem;flex-wrap:wrap;">
        <button class="btn" onclick="showAiPanel()" style="flex:1;padding:0.75rem;font-size:1rem;background:linear-gradient(135deg,#7c3aed,#6d28d9);border:none;">
            <span style="margin-right:0.5rem;">&#9733;</span> AI Assist
        </button>
        <button class="btn" onclick="document.getElementById('confessional-file').click()" id="confessional-upload-btn" style="flex:1;padding:0.75rem;font-size:1rem;background:linear-gradient(135deg,#d4930d,#b8860b);border:none;">
            &#128247; Upload Confessionals
        </button>
        <input type="file" id="confessional-file" accept="image/jpeg,image/png,image/webp" style="display:none" onchange="uploadConfessionals(this)">
        <span id="confessional-loading" class="hidden"><span class="spinner"></span> Parsing image...</span>
        <button class="btn" onclick="submitScores()" style="flex:2;padding:0.75rem;font-size:1rem">Submit Scores</button>
    </div>`;

    // AI recap panel (hidden by default)
    html += `<div id="ai-recap-panel" class="card hidden" style="margin-top:1rem;border:1px solid #7c3aed;">
        <h3 class="card-header" style="color:#a78bfa;">AI Scoring Assistant</h3>
        <div class="form-group">
            <label>Episode Recap (optional)</label>
            <textarea id="ai-recap-text" rows="5" placeholder="Paste an episode recap for better accuracy, or leave blank for best-guess scoring based on typical Survivor patterns..." style="width:100%;resize:vertical;"></textarea>
        </div>
        <div style="display:flex;gap:0.75rem;align-items:center;">
            <button class="btn" onclick="runAiScoring()" id="ai-generate-btn" style="background:linear-gradient(135deg,#7c3aed,#6d28d9);border:none;">Generate Suggestions</button>
            <button class="btn btn-outline" onclick="hideAiPanel()">Cancel</button>
            <span id="ai-loading" class="hidden"><span class="spinner"></span> Asking Claude...</span>
        </div>
    </div>`;

    // AI notes card (hidden until results come back)
    html += `<div id="ai-notes-card" class="card hidden" style="margin-top:1rem;border:1px solid #7c3aed;">
        <h3 class="card-header" style="color:#a78bfa;">AI Notes</h3>
        <div id="ai-notes-content"></div>
    </div>`;

    container.innerHTML = html;
}

function showAiPanel() {
    document.getElementById('ai-recap-panel').classList.remove('hidden');
}

function hideAiPanel() {
    document.getElementById('ai-recap-panel').classList.add('hidden');
}

async function runAiScoring() {
    const epId = document.getElementById('episode-select').value;
    if (!epId) return;

    const alertBox = document.getElementById('scoring-alert');
    const recapText = document.getElementById('ai-recap-text').value;
    const loading = document.getElementById('ai-loading');
    const genBtn = document.getElementById('ai-generate-btn');

    genBtn.disabled = true;
    loading.classList.remove('hidden');

    try {
        const result = await apiPost(
            `/api/seasons/${currentSeasonId}/episodes/${epId}/ai-suggest`,
            { recap_text: recapText || null }
        );
        populateGridFromAi(result.suggestions);
        showAiNotes(result);
        hideAiPanel();
        showAlert(alertBox, `AI filled ${result.suggestions.length} castaways. Review and adjust before submitting.`, 'success');
    } catch (err) {
        showAlert(alertBox, `AI Assist error: ${err.message}`);
    } finally {
        genBtn.disabled = false;
        loading.classList.add('hidden');
    }
}

function populateGridFromAi(suggestions) {
    // Clear any previous AI highlights
    document.querySelectorAll('.ai-highlight').forEach(el => {
        el.classList.remove('ai-highlight');
        el.removeAttribute('title');
    });

    for (const s of suggestions) {
        const row = document.querySelector(`tr[data-castaway-id="${s.castaway_id}"]`);
        if (!row) continue;

        for (const [ruleKey, value] of Object.entries(s.event_data)) {
            const input = row.querySelector(`[data-rule="${ruleKey}"]`);
            if (!input) continue;

            if (input.tagName === 'SELECT') {
                input.value = value ? '1' : '0';
            } else {
                input.value = value;
            }

            // Highlight low-confidence cells with gold border
            const note = s.confidence_notes[ruleKey];
            if (note) {
                const cell = input.closest('td');
                cell.classList.add('ai-highlight');
                cell.title = note;
            }
        }
    }
}

function showAiNotes(result) {
    const card = document.getElementById('ai-notes-card');
    const content = document.getElementById('ai-notes-content');

    let html = '';
    if (result.episode_summary) {
        html += `<p><strong>Summary:</strong> ${escapeHtml(result.episode_summary)}</p>`;
    }
    if (result.eliminated && result.eliminated.length > 0) {
        html += `<p><strong>Eliminated:</strong> ${result.eliminated.map(escapeHtml).join(', ')}</p>`;
    }
    if (result.notes) {
        html += `<p><strong>Notes:</strong> ${escapeHtml(result.notes)}</p>`;
    }
    html += `<p style="font-size:0.8rem;color:var(--text-muted);margin-top:0.5rem;">
        <span style="display:inline-block;width:12px;height:12px;border:2px solid #d4930d;border-radius:2px;margin-right:4px;vertical-align:middle;"></span>
        Gold-bordered cells = low confidence. Verify before submitting.
    </p>`;

    content.innerHTML = html;
    card.classList.remove('hidden');
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

async function uploadConfessionals(fileInput) {
    const epId = document.getElementById('episode-select').value;
    if (!epId || !fileInput.files.length) return;

    const alertBox = document.getElementById('scoring-alert');
    const uploadBtn = document.getElementById('confessional-upload-btn');
    const loading = document.getElementById('confessional-loading');

    uploadBtn.disabled = true;
    loading.classList.remove('hidden');

    try {
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const auth = getAuth();
        const resp = await fetch(`/api/seasons/${currentSeasonId}/episodes/${epId}/parse-confessionals`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${auth.access_token}` },
            body: formData,
        });
        if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.detail || 'Upload failed');
        }
        const result = await resp.json();

        // Fill confessional_count cells in the grid
        let matched = 0;
        for (const entry of result.confessionals) {
            const row = document.querySelector(`tr[data-castaway-id="${entry.castaway_id}"]`);
            if (!row) continue;
            const input = row.querySelector('[data-rule="confessional_count"]');
            if (!input) continue;
            input.value = entry.count;
            // Remove gold highlight on this cell
            const cell = input.closest('td');
            cell.classList.remove('ai-highlight');
            cell.removeAttribute('title');
            matched++;
        }

        showAlert(alertBox, `Confessional counts filled for ${matched} of ${result.confessionals.length} castaways.`, 'success');
    } catch (err) {
        showAlert(alertBox, `Confessional upload error: ${err.message}`);
    } finally {
        uploadBtn.disabled = false;
        loading.classList.add('hidden');
        fileInput.value = '';  // Reset so same file can be re-uploaded
    }
}

async function submitScores() {
    const epId = document.getElementById('episode-select').value;
    const alertBox = document.getElementById('scoring-alert');
    const rows = document.querySelectorAll('#scoring-grid-container tr[data-castaway-id]');

    const events = [];
    rows.forEach(row => {
        const castawayId = parseInt(row.dataset.castawayId);
        const eventData = {};
        row.querySelectorAll('[data-rule]').forEach(input => {
            const key = input.dataset.rule;
            const val = input.tagName === 'SELECT' ? parseInt(input.value) : parseFloat(input.value) || 0;
            eventData[key] = val;
        });
        events.push({ castaway_id: castawayId, event_data: eventData });
    });

    try {
        const result = await apiPost(`/api/seasons/${currentSeasonId}/episodes/${epId}/score`, { events });
        let msg = 'Scores submitted! ';
        result.scores.sort((a, b) => b.calculated_score - a.calculated_score);
        const top3 = result.scores.slice(0, 3).map(s => `${s.castaway_name}: ${s.calculated_score.toFixed(2)}`).join(', ');
        msg += `Top scorers: ${top3}`;
        showAlert(alertBox, msg, 'success');
        await loadEpisodes();
    } catch (err) {
        showAlert(alertBox, err.message);
    }
}
</script>
{% endblock %}
